<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />


    <style>
#yoba_track {
  border-bottom: 1px solid black;
}
    </style>

    <script>

/* Initialize canvas */
var canvasElement = null;
var ctx = null;

/* Script interval ID */
var scriptIntervalID = null;


/* Array of YOBAS */
YOBAS = [];


function moveYobas()
{

  /*
    Rotate and move all Yobas
  */


  var π = Math.PI;  // Math.PI alias

  // Clear screen before render
  ctx.clearRect(0, 0, canvasElement.width, canvasElement.height);

  // Calculate speed, position and direction for each Yoba
  for(var yobaIndex = 0; yobaIndex < YOBAS.length; ++yobaIndex) {
    var y = YOBAS[yobaIndex];

    // Aliases

    var X0 = y.position - y.radius, // TODO: what if params.position < R?
        Y0 = canvasElement.height - 2 * y.radius,
        R  = y.radius,
        ΔS = y.speed;


    // If Yoba has come to the edge

    if(y.position + R + ΔS >= canvasElement.width && ΔS > 0)
      ΔS = - Math.abs(ΔS);
                              // Right border - move left
    else if(y.position - R + ΔS <= 0 && ΔS < 0)
      ΔS = + Math.abs(ΔS);
                              // Left border - move right


    // Check to other Yobas on the way

    var bumpedYobaIndex = -1;
                        // The index of a nearby Yoba, which will be bumped

    // Check positions of each Yoba
    for(var i = 0; i < YOBAS.length; ++i) {
      if(i != yobaIndex) { // Not check self
        var oR = YOBAS[i].position + YOBAS[i].radius + YOBAS[i].speed,
            oL = YOBAS[i].position - YOBAS[i].radius + YOBAS[i].speed,
            yR = y.position + R + ΔS,
            yL = y.position - R + ΔS;

        // If there will be a collision
        if(yR >= oL && yR <= oR || yR <= oR && yR >= oL)
          bumpedYobaIndex = i;
                            // Remember that Yoba's index
      }
    }


    if(bumpedYobaIndex != -1) { // If there will be a collision

      // Calculate speeds after bump

      var m1 = y.radius,
          m2 = YOBAS[bumpedYobaIndex].radius,
          v1 = y.speed,
          v2 = YOBAS[bumpedYobaIndex].speed;

      // p01 + p02 = p1 + p2
      var v11 = ((m1 - m2) * v1 + 2 * m2 * v2) /
                    (m1 + m2),

          v21 = (2 * m1 * v1 + (m2 - m1) * v2) /
                    (m1 + m2);

      ΔS = v11;
      YOBAS[bumpedYobaIndex].speed = v21;
    }



    // Calculate the force of rolling friction and speed

    var f = 0.3,
        N = 9.8 * R;    // F = mg, Radius as mass, TODO: mass in params

    var a = (N * (f / R)) / R;    // TODO: radius not needed?


    // What the fuck? Rewrite this shit!
    ΔS -= (ΔS > 0) ? a : -a;


    // Calculate angle and angle increment

    var Δφ = 2 * π + (Math.round(ΔS) / R);
    var φ = y.angle + Δφ;


    // Rotate and draw Yoba

    ctx.save();
    ctx.translate(X0 + Math.round(ΔS), Y0);

    ctx.translate(R, R);
    ctx.rotate(φ);
    ctx.drawImage(YOBAS[0].src, -R, -R, 2 * R, 2 * R);

    ctx.restore();

    // Remember calculated variables

    y.angle = φ % (4 * π);
    y.position += Math.round(ΔS);
                              // Attention! position MUST be integer
    y.speed = ΔS;
                              // Speed can be float
  }


  // If all Yobas stopped spining, stop script
  var allYobasStop = true;
  for(var i in YOBAS) {
    if(Math.floor(YOBAS[i].speed) != 0) {
      allYobasStop = false;
      break;
    }
  }

  // If all Yobas stops
  if(allYobasStop) {
    // Stop render Yobas
    clearInterval(scriptIntervalID);

    setTimeout(function() {
      console.log("Stop script");
    }, 1000);
  }

}


function Yoba(params)
{

  /*
    Yoba constructor

    Initialize Yoba and render to canvas,
    call (new Yoba()) for create new Yoba
  */


  var yobaImage = new Image();
  yobaImage.src = "yoba_image.png";

  // Rotate yoba
  YOBAS.push({
          src:        yobaImage,
          position:   params.position,
          radius:     params.radius,
          speed:      params.speed,
          angle:      0,
  });
}



function drawYobas()
{
  /*
    Initialize canvas, screen, Yobas, render Yobas
  */


  // Initialize canvas
  canvasElement = document.getElementById("yoba_track");
  ctx = canvasElement.getContext("2d");

  // Create Yobas
  new Yoba({ radius: 50, position: 950, speed: 10 });
  new Yoba({ radius: 40, position: 400, speed: 15 });
  // new Yoba({ radius: 60, position: 900, speed: 25 });


  // Rotate and Yobas, render every 60ms
  // Remember script interval ID to destroy script when all Yobas stops
  scriptIntervalID = setInterval(moveYobas, 60);

}

    </script>

  </head>
  <body onload="drawYobas()">

    <canvas id="yoba_track" width="1000" height="150"></canvas>

  </body>
</html>
