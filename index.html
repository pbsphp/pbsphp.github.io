<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />

    <script>

/* Initialize canvas */
canvasElement = null;
ctx = null;
// TODO: make var

/* Array of YOBAS */
YOBAS = [];


function moveYobas()
{

  /*
    Rotate and move all Yobas
  */


  var π = Math.PI;  // Math.PI alias

  // Clear screen before render
  ctx.clearRect(0, 0, canvasElement.width, canvasElement.height);

  // For each Yoba
  for(var yobaIndex = 0; yobaIndex < YOBAS.length; ++yobaIndex) {
    var y = YOBAS[yobaIndex];

    // Aliases
    var X0 = y.position - y.radius, // TODO: what if params.position < R?
        Y0 = canvasElement.height - 2 * y.radius,
        R  = y.radius,
        ΔS = y.speed;

    // Calculate angle and angle increment
    var Δφ = 2 * π + y.direction * (ΔS / R);
    var φ = y.angle + Δφ;


    // Calculate direction and next position

    // If Yoba at begin or end
    if(y.position + R + ΔS > canvasElement.width ||
       y.position - R - ΔS < 0)
            y.direction = -y.direction; // Switch direction


    // Check to other Yobas on the way
    var thereIsYoba = -1; // TODO: rename

    for(var i = 0; i < YOBAS.length; ++i) {
      if(i != yobaIndex) {
        var oR = YOBAS[i].position + YOBAS[i].radius,
            oL = YOBAS[i].position - YOBAS[i].radius,
            yR = y.position + R,
            yL = y.position - R;


        // if(y.direction == 1) // No magic numbers
        //   if(y.position + R >= oyX - oyR && y.position - R <= )
        //     thereIsYoba = i;
        // else
        //   if(y.position - R <= oyX + oyR)
        //     thereIsYoba = i;

        if(yR >= oL && yR <= oR || yR <= oR && yR >= oL)
              thereIsYoba = i;

      }
    }

    if(thereIsYoba != -1) {
      y.direction = -y.direction;
      YOBAS[thereIsYoba].direction = -YOBAS[thereIsYoba].direction;
    }



    var ΔX = y.direction * ΔS;


    // Rotate and draw
    ctx.save();
    ctx.translate(X0 + ΔX, Y0);

    ctx.translate(R, R);
    ctx.rotate(φ);
    ctx.drawImage(YOBAS[0].src, -R, -R, 2 * R, 2 * R);

    ctx.restore();

    y.angle = φ % (4 * π);
    y.position += ΔX;
  }

}


function Yoba(params)
{

  /*
    Yoba constructor

    Initialize Yoba and render to canvas,
    call (new Yoba()) for create new Yoba
  */


  var yobaImage = new Image();
  yobaImage.src = "yoba_image.png";

  // Rotate yoba
  YOBAS.push({
          src:        yobaImage,
          position:   params.position,
          radius:     params.radius,
          speed:      params.speed,
          angle:      0,
          direction:  1,
  });
}



function drawYobas()
{
  /*
    Initialize canvas, screen, Yobas, render Yobas
  */


  // Initialize canvas
  canvasElement = document.getElementById("yoba_track");
  ctx = canvasElement.getContext("2d");

  // Create Yobas
  new Yoba({ radius: 50, position: 100, speed: 10 });
  new Yoba({ radius: 50, position: 300, speed: 15 });
  new Yoba({ radius: 60, position: 900, speed: 25 });


  // Rotate and Yobas, render every 60ms
  setInterval(moveYobas, 60);

}

    </script>

  </head>
  <body onload="drawYobas()">

    <canvas id="yoba_track" width="1000" height="150"></canvas>

  </body>
</html>
